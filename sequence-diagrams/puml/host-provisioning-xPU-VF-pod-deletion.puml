@startuml
!pragma teoz true
skinparam noteBorderColor Black
skinparam noteBorderThickness 1
skinparam noteBackgroundColor Yellow

skinparam sequence {
	BoxBorderColor Black
	BoxFontSize 20

	ArrowColor Black
	ArrowThickness 1

	ActorBorderColor Black
	ActorBorderThickness 3
	ActorBackgroundColor Business
	ActorFontSize 15

	ParticipantBorderColor Black
	ParticipantBorderThickness 1
	ParticipantBackgroundColor Business
	ParticipantFontSize 15

	LifeLineBorderColor Black
	LifeLineBorderThickness 1
	LifeLineBackgroundColor LightGray
}

actor "User"
box "Host Server"
	participant "Linux"
	participant "Kubelet"
  box "xPU Host Agent" #LightBlue
         participant "OPI Host Controller"
         participant "gRPC server"
  end box
	participant "xPU Device Plugin" #dodgerblue
	participant "CNI" #LightBlue
	participant "Pod"
        participant "kube-apiserver"
end box

box "xPU"
  box "xPU Agent" #LightBlue
	participant "OPI xPU Controller"
  end box
  participant "OPI API"
end box

== Pod Deletion ==
autonumber

"User" -> "Kubelet": delete pod
"Kubelet" -> "Pod" : stop pod
deactivate "Pod"
"Kubelet" -> "CNI" : cmdDel(VF/SF, config)
activate "CNI"
"CNI" -> "Pod" : VF/SF from pod to host netns
"Pod" --> "CNI" : VF/SF
"CNI" -> "CNI" : clear IPAM
"CNI" -> "gRPC server": clear IPAM
"gRPC server" -> "OPI Host Controller": delete Netdev
"OPI Host Controller" -[#green]> "kube-apiserver": delete OPI Netdev CR
"kube-apiserver" -[#green]> "OPI xPU Controller": Notify delete xPU Netdev CR
"OPI xPU Controller"->"OPI API": Delete the VF/SF
"OPI API" --> "OPI xPU Controller": return success
"gRPC server" --> "CNI": return success
"CNI" --> "Kubelet": return 0
deactivate "CNI"

"Kubelet" -> "Pod" : delete pod
deactivate "Pod"

@enduml
